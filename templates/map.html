<!--
    map.html
    Page carte interactive de l'application Canmore Incident Management.
    Affichage, couches, gestion des incidents, musique et préférences utilisateur.
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Carte interactive - Canmore</title>
    <!-- Feuilles de style et bibliothèques -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="/static/css/style_header.css">
    <link rel="stylesheet" href="/static/css/style_map.css">
    <link rel="stylesheet" href="/static/css/style_header_dark.css" id="header-dark-css" disabled>
    <link rel="stylesheet" href="/static/css/style_map_dark.css" id="dark-css" disabled>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="/static/js/map_incidents_admin.js"></script>
    <script src="/static/js/map_incidents_display.js"></script>
    <script src="/static/js/map_incidents_form.js"></script>
    <script src="/static/js/map_incidents.js"></script>
    <script src="/static/js/theme_toggle.js"></script>
</head>
<body>
    <!-- Barre de navigation principale -->
    <nav class="top-menu-modern">
        <div class="menu-left-modern">
            <a href="/" class="back-icon-modern" title="Retour à l'accueil">
                <img src="/static/icons/back_simple.png" alt="Retour à l'accueil">
            </a>
            <span class="menu-title-modern">Gestion des incidents de Canmore</span>
        </div>
        <ul class="menu-center-modern">
            <li class="dropdown">
                <span class="dropdown-toggle btn-unified">Options d'affichage</span>
                <div class="dropdown-content">
                    <label><input type="checkbox" class="layer-toggle" data-layer="trails" checked> Sentiers</label><br>
                    <label><input type="checkbox" class="layer-toggle" data-layer="parcs" checked> Parcs</label><br>
                    <label><input type="checkbox" class="layer-toggle" data-layer="buildings" checked> Bâtiments</label><br>
                    <label><input type="checkbox" class="layer-toggle" data-layer="sports_fields" checked> Terrains de sport</label><br>
                </div>
            </li>
            <li class="dropdown">
                <span class="dropdown-toggle btn-unified">Gestion des incidents</span>
                <div class="dropdown-content">
                    <label><input type="checkbox" class="incident-filter" data-status="unsolved" checked> Incidents non résolus</label><br>
                    <label><input type="checkbox" class="incident-filter" data-status="solved" checked> Incidents résolus</label>
                </div>
            </li>
            <li>
                <a href="#" class="admin-link btn-unified">Connexion Administrateur</a>
            </li>
        </ul>
        <div class="menu-right-modern">
            <img id="music-icon" src="/static/icons/audio_on.png" alt="Toggle Music" class="icon-modern" title="Activer/Désactiver la musique">
            <button id="settings-btn" style="background:none !important;border:none !important;box-shadow:none !important;cursor:pointer;padding:0;">
                <img src="/static/icons/setting.png" alt="Paramètres" class="icon-modern">
            </button>
        </div>
    </nav>
    <!-- Conteneur principal de la carte -->
    <div id="map-container">
        <div id="map" style="width: 100%; height: 100%;"></div>
    </div>
    <!-- Musique de fond -->
    <audio id="background-music" src="/static/audio/map_audio.mp3" loop></audio>
    <script>
        // Initialisation du thème (mode sombre ou clair)
        initThemeToggle({
            darkCss: '/static/css/style_map_dark.css',
            storageKey: 'darkModeGlobal',
            icon: '/static/icons/setting.png',
            iconClass: 'icon-modern',
            defaultMode: 'light'
        });
        // Gestion de l'icône musique (affichage et contrôle de la musique de fond)
        document.addEventListener('DOMContentLoaded', function() {
            var musicIcon = document.getElementById('music-icon');
            var music = document.getElementById('background-music');
            // Met à jour l'icône selon l'état de la musique
            function updateMusicIcon() {
                if (music.paused) {
                    musicIcon.src = '/static/icons/audio_off.png';
                } else {
                    musicIcon.src = '/static/icons/audio_on.png';
                }
            }
            // La musique démarre en pause par défaut
            music.pause();
            updateMusicIcon();
            // Clic sur l'icône musique : joue ou met en pause
            musicIcon.addEventListener('click', function() {
                if (music.paused) {
                    music.volume = 0.5;
                    music.play();
                } else {
                    music.pause();
                }
                updateMusicIcon();
                // Sauvegarde la préférence côté serveur
                fetch('/save_user_settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ musicOn: !music.paused })
                });
            });
            // Met à jour l'icône si la musique change d'état autrement
            music.addEventListener('play', updateMusicIcon);
            music.addEventListener('pause', updateMusicIcon);
        });
        // Initialisation et gestion de la carte interactive
        window.onload = function() {
            // Crée la carte Leaflet et centre sur Canmore
            window.map = L.map('map').setView([51.089, -115.359], 13);

            // Ajoute les tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors',
            }).addTo(window.map);

            // Styles pour chaque couche GeoJSON
            var styles = {
                buildings: { color: '#800080', fillColor: '#800080', fillOpacity: 0.4, weight: 1 },
                trails: { color: '#0074D9', weight: 3, opacity: 0.7 },
                parcs: { color: '#FFD700', fillColor: '#FFD700', fillOpacity: 0.3, weight: 1 },
                sports_fields: { color: '#2ECC40', fillColor: '#2ECC40', fillOpacity: 0.3, weight: 1 },
                city_boundary: { color: '#888888', fillColor: '#888888', fillOpacity: 0.1, weight: 2 },
            };

            // Stocke les couches GeoJSON chargées
            var geojsonLayers = {
                buildings: null,
                trails: null,
                parcs: null,
                sports_fields: null,
                city_boundary: null,
            };

            // Fonction utilitaire : charge une couche GeoJSON et l'ajoute à la carte
            function loadGeoJsonLayer(url, style, name, key) {
                fetch(url).then(res => res.json()).then(data => {
                    if (key === 'city_boundary') {
                        geojsonLayers[key] = L.geoJSON(data, { style: style, interactive: false });
                    } else {
                        geojsonLayers[key] = L.geoJSON(data, {
                            style: style,
                            onEachFeature: function (feature, layer) {
                                layer.bindPopup(name);
                            },
                        });
                    }
                    geojsonLayers[key].addTo(window.map);
                });
            }

            // Charge toutes les couches GeoJSON (bâtiments, sentiers, parcs, etc.)
            loadGeoJsonLayer('/static/data/buildings.geojson', styles.buildings, 'Bâtiments', 'buildings');
            loadGeoJsonLayer('/static/data/trails.geojson', styles.trails, 'Sentiers', 'trails');
            loadGeoJsonLayer('/static/data/parcs.geojson', styles.parcs, 'Parcs', 'parcs');
            loadGeoJsonLayer('/static/data/sports_fields.geojson', styles.sports_fields, 'Terrains de sport', 'sports_fields');
            loadGeoJsonLayer('/static/data/city_boundary.geojson', styles.city_boundary, 'Limite de la ville', 'city_boundary');

            // Affiche ou masque les couches selon les cases à cocher
            document.querySelectorAll('.layer-toggle').forEach(function (checkbox) {
                checkbox.addEventListener('change', function () {
                    var key = this.getAttribute('data-layer');
                    if (geojsonLayers[key]) {
                        if (this.checked) {
                            geojsonLayers[key].addTo(window.map);
                        } else {
                            window.map.removeLayer(geojsonLayers[key]);
                        }
                    }
                });
            });

            // Initialisation de la gestion des incidents (voir map_incidents.js)
            window.loadCanmoreBoundary('/static/data/city_boundary.geojson', function () {
                window.setupIncidentReporting(window.map);
            });
        };
    </script>
    <!-- WebSocket et menus déroulants -->
    <script src="/static/js/websocket_client.js"></script>
    <script src="/static/js/dropdown_menu.js"></script>
</body>
</html>