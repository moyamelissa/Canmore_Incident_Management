<!--
    report.html
    Page de rapport des incidents pour l'application Canmore Incident Management.
    Statistiques, recherche, export et mise à jour en temps réel.
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport des incidents</title>
    <!-- Feuilles de style et bibliothèques -->
    <link rel="stylesheet" href="/static/css/style_header.css">
    <link rel="stylesheet" href="/static/css/style_report.css">
    <link rel="stylesheet" href="/static/css/style_header_dark.css" id="header-dark-css" disabled>
    <link rel="stylesheet" href="/static/css/style_report_dark.css" id="dark-css" disabled>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- En-tête de navigation unifié -->
    <nav class="top-menu-modern">
        <div class="menu-left-modern">
            <a href="/" class="back-icon-modern" title="Retour à l'accueil">
                <img src="/static/icons/back_simple.png" alt="Retour à l'accueil">
            </a>
            <span class="menu-title-modern">Rapport des incidents</span>
        </div>
        <div class="menu-center-modern">
        </div>
        <div class="menu-right-modern">
            <button class="export-btn btn-unified" id="export-btn">Export CSV</button>
            <button id="settings-btn" style="background:none !important;border:none !important;box-shadow:none !important;cursor:pointer;padding:0;margin-left:12px;">
                <img src="/static/icons/setting.png" alt="Paramètres" class="icon-modern">
            </button>
        </div>
    </nav>
    <!-- Cartes de résumé des statistiques -->
    <div style="padding: 12px 32px 0 32px;">
        <div class="summary-cards">
            <div class="summary-card">
                <div class="label">Incidents résolus</div>
                <div class="value" id="resolved-count">0</div>
                <div class="sub">Résolus</div>
            </div>
            <div class="summary-card">
                <div class="label">Incidents non résolus</div>
                <div class="value" id="unresolved-count">0</div>
                <div class="sub red">Non résolus</div>
            </div>
            <div class="summary-card">
                <div class="label">Total incidents</div>
                <div class="value" id="total-count">0</div>
                <div class="sub gray">Total</div>
            </div>
        </div>
    </div>
    <!-- Contenu principal : recherche et tableau -->
    <div class="main-content">
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Rechercher par type, description, statut...">
        </div>
        <div class="table-container">
            <table id="incident-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Date</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rempli dynamiquement par JS -->
                </tbody>
            </table>
        </div>
    </div>
    <!-- Scripts de gestion des incidents, recherche, export et WebSocket -->
    <script>
    // =========================
    // Chargement et affichage des incidents
    // Récupère les incidents depuis l'API et met à jour le tableau et les cartes de résumé
    // =========================
    let allIncidents = [];
    fetch('/api/incidents')
        .then(res => res.json())
        .then(data => {
            allIncidents = data;
            updateTable(data);
            updateSummary(data);
        });

    // =========================
    // Fonction d'affichage du tableau
    // Affiche les incidents dans le tableau avec statut en français et date normalisée
    // =========================
    function updateTable(data) {
        const tbody = document.querySelector('#incident-table tbody');
        tbody.innerHTML = data.map(inc => {
            let statusClass = '';
            let statusFr = inc.status;
            if (inc.status === 'solved' || inc.status === 'résolu') {
                statusClass = 'paid';
                statusFr = 'résolu';
            } else if (inc.status === 'unsolved' || inc.status === 'non résolu') {
                statusClass = 'outstanding';
                statusFr = 'non résolu';
            } else {
                statusClass = 'pending';
            }
            // Normaliser la date au format AAAA-MM-JJ
            let dateOnly = inc.timestamp ? inc.timestamp.split('T')[0] : '';
            return `<tr><td>${inc.id}</td><td>${inc.type}</td><td>${inc.description}</td><td>${dateOnly}</td><td class="status ${statusClass}">${statusFr}</td></tr>`;
        }).join('');
    }

    // =========================
    // Mise à jour des cartes de résumé
    // Calcule et affiche le nombre d'incidents résolus, non résolus et total
    // =========================
    function updateSummary(data) {
        let resolved = 0, unresolved = 0;
        data.forEach(inc => {
            if (inc.status === 'solved' || inc.status === 'résolu') resolved++;
            else unresolved++;
        });
        document.getElementById('resolved-count').textContent = resolved;
        document.getElementById('unresolved-count').textContent = unresolved;
        document.getElementById('total-count').textContent = data.length;
    }

    // =========================
    // Recherche et filtrage
    // Permet de filtrer le tableau par type, description, statut ou date
    // =========================
    document.getElementById('search-input').addEventListener('input', function() {
        const val = this.value.toLowerCase().trim();
        updateTable(allIncidents.filter(inc => {
            let dateOnly = inc.timestamp ? inc.timestamp.split('T')[0] : '';
            let status = (inc.status || '').toString().toLowerCase().trim();
            // Statut en français
            let statusFr = '';
            if (status === 'solved' || status === 'résolu') statusFr = 'résolu';
            else if (status === 'unsolved' || status === 'non résolu') statusFr = 'non résolu';
            else statusFr = status;
            // Statut en anglais
            let statusEn = '';
            if (status === 'solved' || status === 'résolu') statusEn = 'solved';
            else if (status === 'unsolved' || status === 'non résolu') statusEn = 'unsolved';
            else statusEn = status;
            // Recherche intelligente sur le statut
            let matchStatus = false;
            if (val) {
                matchStatus = statusFr.startsWith(val) || statusEn.startsWith(val);
            }
            return (
                (inc.type || '').toString().toLowerCase().includes(val) ||
                (inc.description || '').toString().toLowerCase().includes(val) ||
                matchStatus ||
                dateOnly.includes(val)
            );
        }));
    });

    // =========================
    // Export CSV
    // Permet d'exporter les incidents affichés au format CSV
    // =========================
    document.getElementById('export-btn').addEventListener('click', function() {
        // Ajoute un BOM UTF-8 pour que Excel lise correctement les accents
        let csv = '\ufeffID,Type,Description,Date,Statut\n';
        allIncidents.forEach(inc => {
            const type = (inc.type || '').toString().replace(/"/g, '""');
            const description = (inc.description || '').toString().replace(/"/g, '""');
            // Format date: dd/mm/yyyy (friendly, no time)
            let date = '';
            if (inc.timestamp) {
                const d = new Date(inc.timestamp);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                date = `${day}/${month}/${year}`;
            }
            const status = (inc.status || '').toString();
            csv += `${inc.id},"${type}","${description}",${date},${status}\n`;
        });
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'incidents.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

</script>
    <!-- WebSocket pour la mise à jour en temps réel -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="/static/js/flask_socketio_client.js"></script>
    <script src="/static/js/theme_toggle.js"></script>
    <script>
        initThemeToggle({
            darkCss: '/static/css/style_report_dark.css',
            storageKey: 'darkModeGlobal',
            icon: '/static/icons/setting.png',
            iconClass: 'icon-modern',
            defaultMode: 'light'
        });
    </script>
</body>
</html>
